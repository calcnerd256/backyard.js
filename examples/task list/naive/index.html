<html>
 <head>
  <title>task list</title>
  <template id="task">
   <input type="checkbox" id="task_check"></input>
   <input type="text" id="task_title"></input>
  </template>
  <script src="./task_component.js"></script>
  <script>
   (
    function closures_hate_you(){

     // monofill so I won't have to write it twice
     if("DocumentFragment" in window)
      if(!("getElementById" in DocumentFragment.prototype))
       DocumentFragment.prototype.getElementById = function(id){
        // TODO: per spec, you're supposed to escape certain characters
        // https://developer.mozilla.org/en-US/docs/Web/API/DocumentFragment.querySelector
        // but I'm not going to bother with that until I need it
        return this.querySelector("#" + id);
       };

     var task_objects = [];
     var task_DOM = [];
     function load_local(key){
      if(!arguments.length)
       key = "backyard tasks";
      //we're going to redo this after we get it working
      if(!(key in localStorage)) localStorage[key] = "[]";
      task_objects = JSON.parse(localStorage[key]);

     }
     function save_local(key){
      if(!arguments.length) key = "backyard tasks";
      localStorage[key] = JSON.stringify(task_objects);
     }

     function task_DOM_to_patch(){
      return [];
     }
     function apply_task_patch(patch){
      patch.forEach(
       function(p){
        var task = task_objects[p.id]
        task[p.key] = p["new"];
        console.log(task);
       }
      );
     }
     function task_state_to_DOM(){
     }
     function register_DOM_task(elem){
      var i = task_DOM.length;
      task_DOM.push(elem);
      task_objects[i] = {};
      // when its properties change
      function handle_change(mutations){
       // compute a patch
       var patch = mutations.map(
        function(rec){
         var key = rec.attributeName;
         var old = rec.oldValue;
         var nv = elem.getAttribute(key);
         return {id: i, key: key, old: old, "new": nv};
        }
       );
       // apply the patch to the local state
       apply_task_patch(patch);
       // save the state
       var key = "backyard tasks";//maybe upvar this
       save_local(key);
      }
      // TODO: register this behavior
      var observer = new MutationObserver(handle_change);
      var options = {
       attributes: true,
       attributeOldValue: true,
       attributeFilter: ["finished", "title"]
      };
      observer.observe(elem, options);
     }
     function ensure_custom_element_events(){
      if(!("backyard events" in window))
       window["backyard events"] = {};
      var events = window["backyard events"];
      if(!("custom elements" in events))
       events["custom elements"] = {};
      var elements = events["custom elements"];
      return elements;
     }
     function ensure_task_created_callbacks(){
      var element_listeners = ensure_custom_element_events();
      if(!("backyard-task" in element_listeners))
       element_listeners["backyard-task"] = {};
      var task_callbacks = element_listeners["backyard-task"];
      if(!("created" in task_callbacks))
       task_callbacks.created = function created(elem){
        return created.callbacks.map(function(f){return f.call(elem);});
       };
      var created = task_callbacks.created;
      if(!("callbacks" in created))
       created.callbacks = [];
      return created.callbacks;
     }
     function setup_task_DOM_listeners(){
      // set up listeners to modify and save tasks when DOM changes
      //for each <backyard-task />
      var existing = document.getElementsByTagName("backyard-task");
      [].forEach.call(existing, register_DOM_task);
      // listen for incoming ones to register them
      ensure_task_created_callbacks().push(
       function(){
        return register_DOM_task(this);
       }
      );
     }

     function ready(){
      var task_template = document.getElementById("task");
      var temple = task_template;
      load_local("backyard tasks");

      var patch = task_DOM_to_patch();
      apply_task_patch(patch);

      task_state_to_DOM();
      setup_task_DOM_listeners();

     }

     document.addEventListener(
      "readystatechange",
      function stateChangeHandler(){
       if("complete" == document.readyState) ready();
      }
     );
    }
   )();
  </script>
 </head>
 <body>
  <h1>TODO</h1>
  <ul id="tasks">
   <li>
    <backyard-task />
   </li>
  </ul>
 </body>
</html>
